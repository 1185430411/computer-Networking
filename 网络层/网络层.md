网络层使用IP协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。
与IP协议配套使用的有3个协议：
1.ARP协议
2.ICMP协议
3.IGMP协议

## 一.IP数据包格式

#### 版本：
有 4（IPv4）与6（IPv6）两个值。

#### 首部长度：
占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。

#### 区分服务：
用来获得更好的服务，一般情况不使用。

#### 总长度：
包括首部长度与数据部分长度。

#### 生存时间：
TTL。为了防止无法交付的数据报在网络中循环无休止的传输。用来记录在路由器的跳数，每经过一个路由器，TTL减一，当TTL=0时，数据包被丢弃。

#### 协议：
指出数据部分应该交由哪个协议进行处理，如ARP协议，ICMP协议。

#### 首部检验和：
每经过一个路由器，需要重新计算检验和，因此检验和不包含数据部分可以减少路由器的工作量（注意，IP的首部检验和仅仅检验首部，而不关心数据部分。UDP和TCP的检验即检验首部也检验数据部分。那为什么UDP还是不可靠传输？因为UDP只负责接收无差错的报文，而不负责纠错，纠错由高层协议来完成。TCP还有重传功能）

#### 标识：
在数据报长度过长从而发生分片的情况下，相同数据报的不同分片有不同的标识。

#### 片偏移：
和标识一起，用于数据报分片的情况，片偏移的单位为8字节


## 二.IP地址编址方式

1.分类  2.子网划分  3.无分类

#### 分类

IP地址由两部分组成：网络号和主机号，其中不同分类具有不同的长度。IPv4中IP地址总长为32位。

A类地址：前8位为网络号，后面24位为主机号。

B类地址：前16位网络号，后面16位为主机号。

C类地址：前24位网络号，后8位为主机号。

D类地址：多播地址。

E类地址：保留为今后使用。

#### 子网划分

在主机号中拿出几位作为子网，即可以对N类网络进行再划分。二级IP地址变为三级IP地址。

要使用子网，则必须使用子网掩码，子网掩码的作用就是与IP地址进行与运算，获得对应网段的地址。如A类地址的默认子网掩码就是255.0.0.0，B类地址的默认子网掩码就是255.255.0.0.

外界是看不到子网的。

#### 无分类（CIDR）：

无分类编制CIDR消除了传统ABC类IP地址以及使用子网划分的方式，而是用网络前缀和主机号来对IP地址进行分类。网络前缀的长度可以根据需要改变

CIDR的记法采用了IP地址加上网络前缀长度的方法。例： 192.168.1.2/20 指前20位为网络前缀。

一个CIDR地址中有许多其他地址，故一个CIDR表示的网络可以表示多个网络，所以只需要一个路由器即可完成多个路由器的工作，这叫路由聚合，也叫构成超网。

## 三.地址解析协议ARP

网络层实现主机之间的通信，而链路层实现各段链路之间的通信。因此再这个过程中，IP数据包的源地址和目的地址始终不变，而MAC地址随着链路不同再改变。

ARP协议实现由IP地址获知MAC地址。

每个主机都有一个ARP高速缓存，存着本局域网内的路由器和主机IP和MAC地址的映射。
当A想与B进行通信，A有B的IP地址，但A的ARP高速缓存中没有B的IP地址到MAC地址的映射。此时A通过广播的方式发送ARP请求分组，B接到后会发送ARP响应分组告诉A主机的MAC地址，随后A在自己的ARP高速缓存中写入B的IP地址和MAC地址的映射。

## 四.网络控制报文协议ICMP
ICMP协议用来向主机和路由器报告差错和异常情况。有两个主要应用Ping和Traceroute。

#### Ping
用来测试两台主机之间的连结性。发送请求报文与回收确认报文，求出成功响应次数和丢包率。

#### Traceroute

跟踪源点到终点的路径（TTL）发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

## 五.虚拟专用网VPN

由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

有三个专用地址块：

10.0.0.0 ~ 10.255.255.255
172.16.0.0 ~ 172.31.255.255
192.168.0.0 ~ 192.168.255.255

## 六.网络地址转换NAT

专用网内部的主机使用本地IP，却又想和互联网上的主机通信时，采用NAT将本地IP转换为全球IP。


## 七.路由器分组转发流程

1.从数据报的首部提取目的IP地址D，并获得目的网络地址P

2.若路由表中有目的地址为D的特定主机路由，则把数据报交付给表中所指明的下一跳路由器。

3.若路由表中有目的地址为P的路由，则把数据报交付给表中所指明的下一跳路由器。

3.若路由表中有一个默认路由，则把数据交付给表中指明的默认路由。

4.报错。

## 八.路由选择协议

互联网可以划分为多个自治系统AS，不同的AS可以使用不同的协议。

路由选择协议可以分为两大类：
1.自治系统内部路由选择：RIP与OSPF。

2.自治系统外部路由选择：BGP。

#### RIP

RIP是一个基于距离向量算法的路由选择算法，距离是指跳数，直接连接的路由器跳数为1，若跳数超过15，则认为目的路由器不可到达。

RIP规定路由器按固定一个时间，仅与相邻的路由器交换自己的整个路由表（即自己所有网络的距离信息）。经过若干次交换后，所有的路由器都知道自己到任意一个网络的最短距离和下一跳。

RIP的优点是协议实现简单，开销小。  但缺点是：15跳的规定，限制了网络的规模，当网络出现故障时，要经过较长时间才能被所有路由器知道（即坏事传得慢）

#### OSPF

开放最短路径优先OSPF，是为了解决RIP的缺点提出的。使用了dijkstra算法计算最短路径。

与RIP不同的是，OSPF是每隔一段时间。与整个网络交换自己路由表的部分（仅交换自己与相邻网络的连接情况）。所以OSPF具有全网的拓扑结构图，当发生错误时，路由器更快知道。

#### BGP
边界网关协议

每个自治系统之间的路由选择很困难，因为

1.互联网规模庞大。

2.不同AS里使用着不同的协议。

3.AS之间的路由选择有特殊考虑，比如有些AS实在不让某个AS通过。

BGP只能找到各个AS之间的较好路由，而不是最佳路由。







